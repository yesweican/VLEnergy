
RG="VLEnergy"
APP="vx-webapp"
PLAN="vx-plan"
FUNCAPP="datainjectfunc-app"

az group create -n $RG -l canadacentral

# App Service plan
az appservice plan create --name $PLAN --resource-group $RG --sku B1

# Create Web App
az webapp create \
  --name $APP \
  --resource-group $RG \
  --plan $PLAN \
  --runtime "dotnet:8"

# Create Storage Account
az storage account create \
  --name vxstorageacct \
  --resource-group $RG \
  --location canadacentral \
  --sku Standard_LRS

# Create Function App
az functionapp create \
  --resource-group $RG \
  --name $FUNCAPP \
  --storage-account vxstorageacct \
  --os-type Linux \
  --runtime python \
  --runtime-version 3.11 \
  --functions-version 4 \
  --consumption-plan-location canadacentral

# Retrieve Managed Identities
az functionapp identity show \
  --name vx-functionapp \
  --resource-group vx-rg \
  --query principalId \
  -o tsv

az webapp identity show \
  --name vx-webapp \
  --resource-group vx-rg \
  --query principalId \
  -o tsv

# Use above Identities to access KeyVault
az keyvault set-policy \
  --name vx-keyvault \
  --object-id <FUNCTION_APP_OBJECT_ID> \
  --secret-permissions get list

az keyvault set-policy \
  --name vx-keyvault \
  --object-id <WEBAPP_OBJECT_ID> \
  --secret-permissions get list


